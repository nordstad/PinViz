name: Publish to PyPI

on:
  push:
    tags:
      - v*  # Trigger on version tags like v0.1.0

permissions:
  contents: read
  id-token: write  # Required for trusted publishing to PyPI

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/pinviz
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Python 3.13
        run: uv python install 3.13

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        run: uv publish

  test-published:
    name: Test Published Package
    runs-on: ubuntu-latest
    needs: publish
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Wait for PyPI propagation
        run: sleep 60  # Wait for package to be available on PyPI

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Python
        run: uv python install ${{ matrix.python-version }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create virtual environment
        run: uv venv .venv

      - name: Install published package
        env:
          PACKAGE_VERSION: ${{ steps.version.outputs.VERSION }}
        run: uv pip install pinviz==$PACKAGE_VERSION

      - name: Verify CLI installation
        run: |
          uv run pinviz --version
          uv run pinviz list

      - name: Test basic functionality
        run: |
          # Test that we can import the package
          uv run python -c "from pinviz import boards, devices, Connection, Diagram, SVGRenderer"
          uv run python -c "from pinviz import WireColor, ComponentType, Component"

          # Test that we can create a simple diagram
          uv run python -c "
          from pinviz import boards, devices, Connection, Diagram, SVGRenderer

          board = boards.raspberry_pi_5()
          led = devices.led('Red LED')
          connections = [
              Connection(11, 'Red LED', '+'),
              Connection(6, 'Red LED', '-'),
          ]
          diagram = Diagram('Test', board, [led], connections)
          renderer = SVGRenderer()
          renderer.render(diagram, 'test.svg')
          print('✓ Package works correctly')
          "

      - name: Test built-in examples
        run: |
          uv run pinviz example bh1750 -o bh1750_test.svg
          uv run pinviz example ir_led -o ir_led_test.svg
          if [ -f bh1750_test.svg ] && [ -f ir_led_test.svg ]; then
            echo "✓ Example generation works"
          else
            echo "✗ Example generation failed"
            exit 1
          fi
