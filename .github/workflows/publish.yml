name: Publish to PyPI

on:
  push:
    tags:
      - v*  # Trigger on version tags like v0.1.0

permissions:
  contents: read
  id-token: write  # Required for trusted publishing to PyPI

jobs:
  build:
    name: Build and validate package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Python 3.13
        run: uv python install 3.13

      - name: Build package
        run: uv build

      - name: Validate package metadata
        run: uv run twine check dist/*

      - name: Run local smoke tests
        run: |
          # Create a clean virtual environment
          uv venv .venv

          # Install the built wheel
          uv pip install dist/*.whl

          # Test CLI installation and basic commands
          uv run pinviz --version
          uv run pinviz list

          # Test example generation
          uv run pinviz example bh1750 -o bh1750_ci.svg

          # Verify the SVG file was created
          test -f bh1750_ci.svg || (echo "Failed to generate example SVG" && exit 1)

          # Test MCP server installation
          uv run pinviz-mcp --version || (echo "Failed to run MCP server" && exit 1)

          echo "✓ Local smoke tests passed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: pypi
      url: https://pypi.org/p/pinviz
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        run: uv publish dist/*

      - name: Create GitHub Release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              generate_release_notes: true,
              draft: false,
              prerelease: tag.includes('-')
            });

            return {
              version: tag.replace('v', ''),
              body: release.data.body
            };

      - name: Update CHANGELOG.md
        env:
          RELEASE_DATA: ${{ steps.create_release.outputs.result }}
        run: |
          # Parse release data
          VERSION=$(echo "$RELEASE_DATA" | jq -r '.version')
          RELEASE_DATE=$(date +%Y-%m-%d)

          # Save release notes to temp file
          echo "$RELEASE_DATA" | jq -r '.body' > release_notes.txt

          # Run update script
          uv run python scripts/update_changelog.py "$VERSION" release_notes.txt "$RELEASE_DATE"

          # Check if CHANGELOG.md was modified
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
          else
            echo "CHANGELOG.md updated successfully"
          fi

      - name: Commit and push CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "No changes to commit"
          else
            git add CHANGELOG.md
            git commit -m "Update CHANGELOG.md for release ${GITHUB_REF#refs/tags/}"
            git push origin HEAD:main
          fi

  test-published:
    name: Test Published Package (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: publish
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Install Python
        run: uv python install ${{ matrix.python-version }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create virtual environment
        run: uv venv .venv

      - name: Install published package with retry
        env:
          PACKAGE_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          echo "Installing pinviz==${PACKAGE_VERSION} from PyPI..."

          # Retry loop to handle PyPI propagation delay
          for i in 1 2 3 4 5; do
            echo "Attempt $i/5..."

            if uv pip install "pinviz==${PACKAGE_VERSION}" && uv run pinviz --version; then
              echo "✓ Successfully installed pinviz from PyPI"
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "PyPI not ready yet, retrying in 30s..."
              sleep 30
            fi
          done

          echo "✗ Failed to install package after 5 attempts"
          exit 1

      - name: Verify CLI installation
        run: |
          uv run pinviz --version
          uv run pinviz list
          uv run pinviz-mcp --version

      - name: Test basic functionality
        run: |
          # Test that we can import the package
          uv run python -c "from pinviz import boards, devices, Connection, Diagram, SVGRenderer"
          uv run python -c "from pinviz import WireColor, ComponentType, Component"

          # Test that we can create a simple diagram
          uv run python -c "
          from pinviz import boards, devices, Connection, Diagram, SVGRenderer

          board = boards.raspberry_pi_5()
          led = devices.simple_led('Red')
          connections = [
              Connection(11, 'Red LED', '+'),
              Connection(6, 'Red LED', '-'),
          ]
          diagram = Diagram('Test', board, [led], connections)
          renderer = SVGRenderer()
          renderer.render(diagram, 'test.svg')
          print('✓ Package works correctly')
          "

      - name: Test built-in examples
        run: |
          uv run pinviz example bh1750 -o bh1750_test.svg
          uv run pinviz example ir_led -o ir_led_test.svg
          if [ -f bh1750_test.svg ] && [ -f ir_led_test.svg ]; then
            echo "✓ Example generation works"
          else
            echo "✗ Example generation failed"
            exit 1
          fi
