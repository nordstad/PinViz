name: Publish to PyPI

on:
  push:
    tags:
      - v*  # Trigger on version tags like v0.1.0

permissions:
  contents: read
  id-token: write  # Required for trusted publishing to PyPI

jobs:
  build:
    name: Build and validate package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Python 3.13
        run: uv python install 3.13

      - name: Build package
        run: uv build

      - name: Validate package metadata
        run: uv run twine check dist/*

      - name: Run local smoke tests
        run: |
          # Create a clean virtual environment
          uv venv .venv

          # Install the built wheel
          uv pip install dist/*.whl

          echo "=========================================="
          echo "PRE-PUBLISH SMOKE TESTS"
          echo "Testing all features (existing + v0.7.0)"
          echo "=========================================="

          # Test 1: CLI installation and basic commands
          echo ""
          echo "[1/10] Testing CLI installation..."
          uv run pinviz --version
          uv run pinviz list | grep -q "raspberry_pi_5" || (echo "✗ Board list missing" && exit 1)
          uv run pinviz list | grep -q "bh1750" || (echo "✗ Device templates missing" && exit 1)
          echo "✓ CLI commands work"

          # Test 2: All built-in examples
          echo ""
          echo "[2/10] Testing all built-in examples..."
          uv run pinviz example bh1750 -o bh1750_ci.svg
          uv run pinviz example ir_led -o ir_led_ci.svg
          uv run pinviz example i2c_spi -o i2c_spi_ci.svg
          test -f bh1750_ci.svg || (echo "✗ BH1750 example failed" && exit 1)
          test -f ir_led_ci.svg || (echo "✗ IR LED example failed" && exit 1)
          test -f i2c_spi_ci.svg || (echo "✗ I2C/SPI example failed" && exit 1)
          echo "✓ All examples work"

          # Test 3: Board aliases
          echo ""
          echo "[3/10] Testing board aliases..."
          cat > alias_test.yaml << 'EOF'
          title: "Alias Test"
          board: "rpi4"
          devices:
            - type: "led"
              name: "LED"
          connections:
            - board_pin: 11
              device: "LED"
              device_pin: "+"
            - board_pin: 9
              device: "LED"
              device_pin: "-"
          EOF
          uv run pinviz render alias_test.yaml -o alias_test.svg || (echo "✗ Board alias failed" && exit 1)
          echo "✓ Board aliases work"

          # Test 4: MCP server installation
          echo ""
          echo "[4/10] Testing MCP server..."
          uv run pinviz-mcp --version || (echo "✗ Failed to run MCP server" && exit 1)
          echo "✓ MCP server works"

          # Test 5: Validation command (valid config)
          echo ""
          echo "[5/10] Testing validation with valid config..."
          cat > valid_config.yaml << 'EOF'
          title: "Valid Test"
          board: "rpi5"
          devices:
            - type: "i2c_device"
              name: "Sensor"
          connections:
            - board_pin: 1
              device: "Sensor"
              device_pin: "VCC"
            - board_pin: 3
              device: "Sensor"
              device_pin: "SDA"
            - board_pin: 5
              device: "Sensor"
              device_pin: "SCL"
            - board_pin: 6
              device: "Sensor"
              device_pin: "GND"
          EOF
          uv run pinviz validate valid_config.yaml || (echo "✗ Validation failed on valid config" && exit 1)
          echo "✓ Valid config validation works"

          # Test 6: Validation command (invalid config - pin conflict)
          echo ""
          echo "[6/10] Testing validation with invalid config..."
          cat > invalid_config.yaml << 'EOF'
          title: "Invalid Test"
          board: "rpi5"
          devices:
            - type: "led"
              name: "LED1"
            - type: "led"
              name: "LED2"
          connections:
            - board_pin: 11
              device: "LED1"
              device_pin: "+"
            - board_pin: 11
              device: "LED2"
              device_pin: "+"
            - board_pin: 9
              device: "LED1"
              device_pin: "-"
            - board_pin: 9
              device: "LED2"
              device_pin: "-"
          EOF
          if uv run pinviz validate invalid_config.yaml; then
            echo "✗ Validation should have failed on invalid config"
            exit 1
          else
            echo "✓ Invalid config validation works (exit code: $?)"
          fi

          # Test 7: Wire styles and colors
          echo ""
          echo "[7/9] Testing wire styles and custom colors..."
          cat > wire_styles.yaml << 'EOF'
          title: "Wire Styles Test"
          board: "rpi5"
          devices:
            - type: "led"
              name: "LED"
          connections:
            - board_pin: 11
              device: "LED"
              device_pin: "+"
              color: "#FF0000"
              style: "curved"
            - board_pin: 9
              device: "LED"
              device_pin: "-"
              style: "orthogonal"
          EOF
          uv run pinviz render wire_styles.yaml -o wire_styles.svg || (echo "✗ Wire styles failed" && exit 1)
          echo "✓ Wire styles and colors work"

          # Test 8: Legend and GPIO reference
          echo ""
          echo "[8/9] Testing legend generation..."
          cat > legend_test.yaml << 'EOF'
          title: "Legend Test"
          board: "rpi5"
          devices:
            - type: "i2c_device"
              name: "Sensor"
          connections:
            - board_pin: 1
              device: "Sensor"
              device_pin: "VCC"
            - board_pin: 3
              device: "Sensor"
              device_pin: "SDA"
          show_legend: true
          EOF
          uv run pinviz render legend_test.yaml -o legend_test.svg || (echo "✗ Legend generation failed" && exit 1)
          grep -q "legend" legend_test.svg || echo "Warning: Legend may not be in SVG"
          echo "✓ Legend generation works"

          # Test 9: Automatic validation during render
          echo ""
          echo "[9/9] Testing automatic validation during render..."
          if uv run pinviz render invalid_config.yaml -o should_fail.svg 2>&1; then
            echo "✗ Render should have failed due to validation errors"
            exit 1
          else
            echo "✓ Automatic validation during render works"
          fi

          echo ""
          echo "=========================================="
          echo "✓ All pre-publish smoke tests passed!"
          echo "=========================================="

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: pypi
      url: https://pypi.org/p/pinviz
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        run: uv publish dist/*

      - name: Create GitHub Release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              generate_release_notes: true,
              draft: false,
              prerelease: tag.includes('-')
            });

            return {
              version: tag.replace('v', ''),
              body: release.data.body
            };

      - name: Update CHANGELOG.md
        env:
          RELEASE_DATA: ${{ steps.create_release.outputs.result }}
        run: |
          # Parse release data
          VERSION=$(echo "$RELEASE_DATA" | jq -r '.version')
          RELEASE_DATE=$(date +%Y-%m-%d)

          # Save release notes to temp file
          echo "$RELEASE_DATA" | jq -r '.body' > release_notes.txt

          # Run update script
          uv run python scripts/update_changelog.py "$VERSION" release_notes.txt "$RELEASE_DATE"

          # Check if CHANGELOG.md was modified
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
          else
            echo "CHANGELOG.md updated successfully"
          fi

      - name: Commit and push CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "No changes to commit"
          else
            git add CHANGELOG.md
            git commit -m "Update CHANGELOG.md for release ${GITHUB_REF#refs/tags/}"
            git push origin HEAD:main
          fi

  test-published:
    name: Test Published Package
    runs-on: ubuntu-latest
    needs: publish
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Install Python
        run: uv python install ${{ matrix.python-version }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create virtual environment
        run: uv venv .venv

      - name: Install published package with retry
        env:
          PACKAGE_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          echo "Installing pinviz==${PACKAGE_VERSION} from PyPI..."

          # Retry loop to handle PyPI propagation delay
          for i in 1 2 3 4 5; do
            echo "Attempt $i/5..."

            if uv pip install "pinviz==${PACKAGE_VERSION}" && uv run pinviz --version; then
              echo "✓ Successfully installed pinviz from PyPI"
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "PyPI not ready yet, retrying in 30s..."
              sleep 30
            fi
          done

          echo "✗ Failed to install package after 5 attempts"
          exit 1

      - name: Verify CLI installation
        run: |
          echo "=========================================="
          echo "POST-PUBLISH INTEGRATION TESTS"
          echo "Python ${{ matrix.python-version }}"
          echo "Testing all features (existing + v0.7.0)"
          echo "=========================================="
          echo ""
          echo "[1/11] Verifying CLI installation..."
          VERSION=$(uv run pinviz --version)
          echo "Installed: $VERSION"
          uv run pinviz list | grep -q "raspberry_pi_5" || (echo "✗ Board list missing" && exit 1)
          uv run pinviz list | grep -q "raspberry_pi_4" || (echo "✗ Pi 4 missing" && exit 1)
          uv run pinviz list | grep -q "bh1750" || (echo "✗ Device templates missing" && exit 1)
          uv run pinviz-mcp --version
          echo "✓ CLI installation verified"

      - name: Checkout code for shared tests
        uses: actions/checkout@v4

      - name: Run post-publish integration tests
        run: |
          echo ""
          echo "[2/2] Running comprehensive integration tests..."
          echo "Using shared test file: tests/post_publish_integration.py"
          echo ""
          uv run python tests/post_publish_integration.py

